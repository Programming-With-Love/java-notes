# 类加载的过程

## 一、加载过程图示

### 加载流程图

![加载流程图](https://gitee.com/ShaoxiongDu/imageBed/raw/master/%E7%AC%AC02%E7%AB%A0_%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.jpg)

### 主要步骤:

#### 装载 -> 链接 - > 初始化

## 二、 装载过程（加载）

- 通过一个类的全限定明获取定义此类的二进制字节流；
- 将这个字节流所代表的的静态存储结构转化为方法区的运行时数据；
- 在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口

## 三、链接过程

![加载示例](https://gitee.com/ShaoxiongDu/imageBed/raw/master/image-20210617145249791.png)

1. ### 验证(Verify)

   ##### 1. 目的:

   在于确保Class文件的字节流中包含信息符合当前虚拟机要求，保证被加载类的正确性，不会危害	虚拟机自身安全。

   ##### 2. 主要包括四种验证

   - 文件格式验证
   - 源数据验证
   - 字节码验证
   - 符号引用验证。

2. ### 准备(Prepare)

    - 为类变量（static）分配内存并且设置初始值。

   - 这里不包含用final修饰的static，因为final在编译的时候就会分配了，准备阶段会显式初始化；
   - 不会为实例变量分配初始化，类变量会分配在方法去中，而实例变量是会随着对象一起分配到java堆中。

3. ### 解析(Resolve)

   - 将常量池内的符号引用转换为直接引用的过程。

   - 事实上，解析操作往往会伴随着JVM在执行完初始化之后再执行

   - 符号引用就是一组符号来描述所引用的目标。符号应用的字面量形式明确定义在《java虚拟机规范》的class文件格式中。直接引用就是直接指向目标的指针、相对偏移量或一个间接定位到目标的句柄

   - 解析动作主要针对类或接口、字段、类方法、接口方法、方法类型等。对应常量池中的CONSTANT_Class_info/CONSTANT_Fieldref_info、CONSTANT_Methodref_info等。

## 四、 初始化过程

- 初始化阶段就是执行类构造器方法clInit（）的过程。 clInit是ClassInit缩写。
- 此方法不需要定义，是javac编译器自动收集类中的所有类变量(Static)的赋值动作和静态代码块中的语句合并而来。

![image-20210617211402802](https://gitee.com/ShaoxiongDu/imageBed/raw/master/image-20210617211402802.png)

- 构造器方法中指令按语句在源文件中出现的顺序执行
- clinit()不同于类的构造器。（关联：构造器是虚拟机视角下的init()）
- 若该类具有父类，jvm会保证子类的clinit()执行前，父类的clinit()已经执行完毕
- 虚拟机必须保证一个类的clinit()方法在多线程下被同步加锁。

![image-20210617211441850](https://gitee.com/ShaoxiongDu/imageBed/raw/master/image-20210617211441850.png)
